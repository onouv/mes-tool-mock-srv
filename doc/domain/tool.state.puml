@startuml
'https://plantuml.com/state-diagram
skinparam defaultTextAlignment left
scale 350 width

[*] --> UP
state DOWN : entry/ issue ToolDownEvent

state UP {
    state UP: entry/ ToolUpEventAction, ToolUpEvent(tool)
    state UP: PART_LOADING / LoadPartAction, PartLoadedEvt(tool, part)
    state UP: PART_UNLOADING / UnloadPartAction, PartUnloadedEvt(tool, part)

    state STOPPED
    STOPPED: entry / ToolStoppedEvent(tool)

    state UP_CHOICE <<choice>>
    [*] --> STOPPED
    STOPPED --> UP_CHOICE: START
    UP_CHOICE --> OPERATING: [ FlowIsFree ]
    UP_CHOICE --> IDLE: [ else ]

    OPERATING --> STOPPED: STOP
    OPERATING --> IDLE

    state IDLE {

        state BLOCKED_UPSTREAM: entry / ToolIdleEvent(UPSTREAM)
        state BLOCKED_DOWNSTREAM: entry / ToolIdleEvent(DOWNSTREAM)
        state IDLE_CHOICE <<choice>>

        [*] --> IDLE_CHOICE
        IDLE_CHOICE --> BLOCKED_UPSTREAM: [ InportEmpty ]
        IDLE_CHOICE --> BLOCKED_DOWNSTREAM: [ else ]
        BLOCKED_DOWNSTREAM --> BLOCKED_UP_AND_DOWNSTREAM: [ InportEmpty ] /\n ToolIdleEvent(UPSTREAM) ]
        BLOCKED_UPSTREAM --> BLOCKED_UP_AND_DOWNSTREAM: [ OutportFull ] /\n ToolIdleEvent(DOWNSTREAM) ]
        BLOCKED_UP_AND_DOWNSTREAM --> BLOCKED_UPSTREAM: [ OutportNotFull ]
        BLOCKED_UP_AND_DOWNSTREAM --> BLOCKED_DOWNSTREAM: [ InportNotEmpty ]
        BLOCKED_DOWNSTREAM --> [*]: [ OutportNotFull ]
        BLOCKED_UPSTREAM --> [*]: [ InputNotEmpty ]
     }

    state OPERATING {
        state LOADING_PROCESS: entry/ PartInProcessEvent(tool, part)
        state UNLOADING_PROCESS: entry/ PartProcessedEvent(tool, part)
        state CHOICE_PROCESS_EMPTY <<choice>>
        state PROCESSING_PART

        [*] --> CHOICE_PROCESS_EMPTY
        CHOICE_PROCESS_EMPTY --> LOADING_PROCESS: [ProcessEmpty]
        CHOICE_PROCESS_EMPTY --> UNLOADING_PROCESS: [else]
        LOADING_PROCESS --> PROCESSING_PART

        PROCESSING_PART --> UNLOADING_PROCESS: [await process time]
        UNLOADING_PROCESS --> LOADING_PROCESS: [ FlowIsFree ]
        UNLOADING_PROCESS --> [*] : [ FlowIsNotFree ]
    }

    IDLE --> OPERATING
    IDLE --> STOPPED: STOP

}

UP --> DOWN: FAULT
DOWN --> UP: FAULT_CLEAR
@enduml